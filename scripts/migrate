#!/bin/sh

# runs all of the *.sql file in the migrations directory
# expects to be run from the root of the project directory

PURPLE='\033[0;35m'
GREEN='\033[0;32m'
RED='\033[0;31m'
RESET='\033[0m'

export PGPASSWORD=$DB_PASSWORD
echo ""
echo " ------ ${RED}Running Migrations${RESET} ------"
for f in migrations/*.sql;
  do
     echo "";
     echo " ‚Ä£ ${PURPLE}$f${RESET}";
     echo "";

     # execute command with minimal logging
     # -E no echo
     # -q quietly

     # we could pipe to sed to print with indentation: | sed 's/^/ /'
     psql -H $DB_HOST -U $DB_USER -Eq -f $f;

     # TODO: use `$?` to determine the color of the output
     if [ $? != 0 ]; then
         echo " ${RED} *** Migration Failed *** ${RESET}";
         echo " ùòÖ ${RED}$f${RESET}";
         exit $?;
     else
         echo "";
         echo " ‚úî ${GREEN}$f${RESET}";
         echo "";
         echo " ---------------------------------------- ";
     fi
done
